{% extends "layouts/base.html" %}

{% block title %}Settings - Deep Research AI{% endblock %}

{% block content %}
<div class="app-container">
    {% with active_page='settings' %}
    {% include "components/sidebar.html" %}
    {% endwith %}

    <main class="main-content" style="background: var(--background); overflow-y: auto; padding: 0;">
        <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>
        
        <div style="max-width: 900px; margin: 3rem auto; padding: 0 1.5rem; width: 100%;">
            
            <header style="margin-bottom: 2.5rem;">
                <h1 style="font-size: 2rem; color: var(--text-main); font-weight: 700; margin-bottom: 0.5rem;">Settings</h1>
                <p style="color: var(--text-muted); font-size: 1.1rem;">Manage your account and application preferences</p>
            </header>

            <!-- Settings Tabs -->
            <div class="settings-tabs">
                <div class="settings-tab active" onclick="switchSettingsTab('profile')">
                    <i class="fas fa-user"></i> Profile
                </div>
                <div class="settings-tab" onclick="switchSettingsTab('preferences')">
                    <i class="fas fa-sliders-h"></i> Preferences
                </div>
                <div class="settings-tab" onclick="switchSettingsTab('api')">
                    <i class="fas fa-key"></i> API Keys
                </div>
                <div class="settings-tab" onclick="switchSettingsTab('security')">
                    <i class="fas fa-shield-alt"></i> Security
                </div>
            </div>

            <!-- Profile Settings -->
            <div id="settings-profile" class="settings-section active">
                <div class="settings-card">
                    <h2 class="settings-title">Profile Information</h2>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profile-name" class="settings-input" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="profile-email" class="settings-input" placeholder="john@example.com">
                    </div>
                    <div class="form-group">
                        <label>Bio</label>
                        <textarea id="profile-bio" class="settings-input" rows="3" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    <button class="btn-primary" onclick="saveProfile()">Save Profile</button>
                </div>
            </div>

            <!-- Preferences Settings -->
            <div id="settings-preferences" class="settings-section">
                <div class="settings-card">
                    <h2 class="settings-title">Application Preferences</h2>
                    
                    <div class="form-group">
                        <label>Theme</label>
                        <select id="pref-theme" class="settings-input">
                            <option value="dark">Dark Mode</option>
                            <option value="light">Light Mode</option>
                            <option value="auto">Auto (System)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Default LLM Model</label>
                        <select id="pref-model" class="settings-input">
                            <option value="llama-3.3-70b-versatile">Llama 3.3 70B (Recommended)</option>
                            <option value="llama-3.1-8b-instant">Llama 3.1 8B (Fast)</option>
                            <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Research Depth (Default Iterations)</label>
                        <input type="number" id="pref-iterations" class="settings-input" min="1" max="10" value="3">
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="pref-notifications">
                            <span>Enable Desktop Notifications</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="pref-auto-save">
                            <span>Auto-save Conversations</span>
                        </label>
                    </div>

                    <button class="btn-primary" onclick="savePreferences()">Save Preferences</button>
                </div>
            </div>

            <!-- API Keys Settings -->
            <div id="settings-api" class="settings-section">
                <div class="settings-card">
                    <h2 class="settings-title">API Configuration</h2>
                    
                    <div class="form-group">
                        <label>Groq API Key</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="password" id="api-groq" class="settings-input" placeholder="gsk_...">
                            <button class="btn-secondary" onclick="toggleApiVisibility('api-groq')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small style="color: var(--text-muted); font-size: 0.85rem;">Get your key from <a href="https://console.groq.com" target="_blank" style="color: var(--primary);">console.groq.com</a></small>
                    </div>

                    <div class="form-group">
                        <label>Rate Limit (Requests/Minute)</label>
                        <input type="number" id="api-rate-limit" class="settings-input" min="1" max="100" value="30">
                    </div>

                    <button class="btn-primary" onclick="saveApiKeys()">Save API Keys</button>
                </div>
            </div>

            <!-- Security Settings -->
            <div id="settings-security" class="settings-section">
                <div class="settings-card">
                    <h2 class="settings-title">Security & Privacy</h2>
                    
                    <div class="form-group">
                        <label>Change Password</label>
                        <input type="password" id="security-current-password" class="settings-input" placeholder="Current Password">
                        <input type="password" id="security-new-password" class="settings-input" placeholder="New Password" style="margin-top: 0.5rem;">
                        <input type="password" id="security-confirm-password" class="settings-input" placeholder="Confirm New Password" style="margin-top: 0.5rem;">
                    </div>

                    <button class="btn-primary" onclick="changePassword()">Update Password</button>

                    <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border);">

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="security-2fa">
                            <span>Enable Two-Factor Authentication (Coming Soon)</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-main);">Data Management</h3>
                        <button class="btn-secondary" onclick="exportData()" style="margin-right: 0.5rem;">
                            <i class="fas fa-download"></i> Export My Data
                        </button>
                        <button class="btn-danger" onclick="deleteAccount()">
                            <i class="fas fa-trash"></i> Delete Account
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>
</div>

<style>
    .settings-tabs {
        display: flex; gap: 0.5rem; margin-bottom: 2rem; overflow-x: auto;
        border-bottom: 2px solid var(--border); padding-bottom: 0;
    }
    .settings-tab {
        padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 500;
        color: var(--text-muted); border-bottom: 3px solid transparent;
        transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 0.5rem;
    }
    .settings-tab:hover { color: var(--text-main); }
    .settings-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

    .settings-section { display: none; }
    .settings-section.active { display: block; }

    .settings-card {
        background: var(--surface); padding: 2.5rem; border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md); border: 1px solid var(--border);
    }

    .settings-title {
        font-size: 1.5rem; font-weight: 700; color: var(--text-main);
        margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);
    }

    .form-group { margin-bottom: 1.5rem; }
    .form-group label {
        display: block; font-weight: 600; color: var(--text-main);
        margin-bottom: 0.5rem; font-size: 0.95rem;
    }

    .settings-input {
        width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border);
        border-radius: var(--radius-md); font-size: 1rem; background: var(--background);
        color: var(--text-main);
        transition: all 0.2s; font-family: inherit;
    }
    .settings-input option { background: var(--surface); color: var(--text-main); }
    .settings-input:focus {
        outline: none; border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .checkbox-label {
        display: flex; align-items: center; gap: 0.75rem; cursor: pointer;
        font-weight: 400 !important;
    }
    .checkbox-label input[type="checkbox"] {
        width: 18px; height: 18px; cursor: pointer;
    }

    .btn-primary, .btn-secondary, .btn-danger {
        padding: 0.75rem 1.5rem; border: none; border-radius: var(--radius-md);
        font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
        display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-primary {
        background: var(--primary); color: white;
    }
    .btn-primary:hover { background: var(--primary-hover); }
    
    .btn-secondary {
        background: var(--background); color: var(--text-main);
        border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--surface); }

    .btn-danger {
        background: #dc2626; color: white;
    }
    .btn-danger:hover { background: #b91c1c; }
</style>

<script>
    function showToast(message, type='info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation' : 'check'}-circle"></i> <span>${message}</span>`;
        if(type === 'error') toast.style.borderLeftColor = 'var(--accent-error)';
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function switchSettingsTab(tabId) {
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
        document.getElementById('settings-' + tabId).classList.add('active');
    }

    function toggleApiVisibility(inputId) {
        const input = document.getElementById(inputId);
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function saveProfile() {
        const data = {
            name: document.getElementById('profile-name').value,
            email: document.getElementById('profile-email').value,
            bio: document.getElementById('profile-bio').value
        };

        try {
            const res = await fetch('/api/settings/profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) showToast('Profile updated successfully!');
            else showToast('Failed to update profile', 'error');
        } catch(e) {
            showToast('Error updating profile', 'error');
        }
    }

    async function savePreferences() {
        const data = {
            theme: document.getElementById('pref-theme').value,
            model: document.getElementById('pref-model').value,
            iterations: parseInt(document.getElementById('pref-iterations').value),
            notifications: document.getElementById('pref-notifications').checked,
            autoSave: document.getElementById('pref-auto-save').checked
        };

        try {
            const res = await fetch('/api/settings/preferences', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) {
                showToast('Preferences saved!');
                // Apply theme immediately
                applyTheme(data.theme);
                // Save to localStorage for persistence
                localStorage.setItem('theme', data.theme);
            }
            else showToast('Failed to save preferences', 'error');
        } catch(e) {
            showToast('Error saving preferences', 'error');
        }
    }

    function applyTheme(theme) {
        if(theme === 'light') {
            document.documentElement.removeAttribute('data-theme');
        } else if(theme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        } else if(theme === 'auto') {
            // Auto mode - use system preference
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if(prefersDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }
    }

    async function saveApiKeys() {
        const data = {
            groq_api_key: document.getElementById('api-groq').value,
            rate_limit: parseInt(document.getElementById('api-rate-limit').value)
        };

        try {
            const res = await fetch('/api/settings/api-keys', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) showToast('API keys updated!');
            else showToast('Failed to update API keys', 'error');
        } catch(e) {
            showToast('Error updating API keys', 'error');
        }
    }

    async function changePassword() {
        const current = document.getElementById('security-current-password').value;
        const newPass = document.getElementById('security-new-password').value;
        const confirm = document.getElementById('security-confirm-password').value;

        if(newPass !== confirm) {
            showToast('Passwords do not match', 'error');
            return;
        }

        try {
            const res = await fetch('/api/settings/change-password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({current_password: current, new_password: newPass})
            });
            if(res.ok) {
                showToast('Password changed successfully!');
                document.getElementById('security-current-password').value = '';
                document.getElementById('security-new-password').value = '';
                document.getElementById('security-confirm-password').value = '';
            }
            else showToast('Failed to change password', 'error');
        } catch(e) {
            showToast('Error changing password', 'error');
        }
    }

    async function exportData() {
        try {
            const res = await fetch('/api/settings/export-data');
            if(res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'my_data.json';
                a.click();
                showToast('Data exported successfully!');
            }
        } catch(e) {
            showToast('Error exporting data', 'error');
        }
    }

    function deleteAccount() {
        if(confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
            showToast('Account deletion feature coming soon', 'error');
        }
    }

    // Load current settings on page load
    window.addEventListener('DOMContentLoaded', async () => {
        // Get saved theme from localStorage (don't force dark mode)
        const savedTheme = localStorage.getItem('theme');
        
        // Only apply theme if it exists, otherwise keep current theme
        if (savedTheme) {
            applyTheme(savedTheme);
        }
        
        try {
            const res = await fetch('/api/settings/current');
            if(res.ok) {
                const data = await res.json();
                if(data.profile) {
                    document.getElementById('profile-name').value = data.profile.name || '';
                    document.getElementById('profile-email').value = data.profile.email || '';
                    document.getElementById('profile-bio').value = data.profile.bio || '';
                }
                if(data.preferences) {
                    const theme = data.preferences.theme || savedTheme || 'light';
                    document.getElementById('pref-theme').value = theme;
                    document.getElementById('pref-model').value = data.preferences.model || 'llama-3.3-70b-versatile';
                    document.getElementById('pref-iterations').value = data.preferences.iterations || 3;
                    document.getElementById('pref-notifications').checked = data.preferences.notifications || false;
                    document.getElementById('pref-auto-save').checked = data.preferences.autoSave || false;
                    
                    // Only apply theme if not already set
                    if (!savedTheme) {
                        applyTheme(theme);
                        localStorage.setItem('theme', theme);
                    }
                }
            }
        } catch(e) {
            console.error('Failed to load settings:', e);
        }
    });
</script>
{% endblock %}
